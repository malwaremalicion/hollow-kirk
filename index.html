<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chirk Knight</title>

<style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; }
    #pauseMenu, #deathMenu {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); color: white; font-family: sans-serif;
        display: none; justify-content: center; align-items: center;
        flex-direction: column; font-size: 32px;
    }
    button {
        margin: 10px; padding: 10px 20px; font-size: 24px;
    }
</style>
</head>

<body>
<canvas id="game"></canvas>

<div id="pauseMenu">
    <div>Paused</div>
    <button onclick="resumeGame()">Resume</button>
    <button onclick="returnToMenu()">Return to Menu</button>
</div>

<div id="deathMenu">
    <div>You Died</div>
    <button onclick="restartGame()">Respawn</button>
    <button onclick="returnToMenu()">Return to Menu</button>
</div>

<script>
let canvas = document.getElementById("game");
let ctx = canvas.getContext("2d");
canvas.width = 1280;
canvas.height = 720;

/* ---------------- ASSET LOADING ------------------ */

let assets = {
    player: load("chirk.png"),
    attack: load("chirka.png"),
    enemy: load("cheese.png"),
    boss: load("supercheese.png"),
    ground: load("g.png"),
    spike: load("stug.png"),
    bg: load("bg.png"),
    fireball: load("BALL.png"),
};

let sfx = {
    step: new Audio("step.mp3"),
    enemyDeath: new Audio("owe.mp3"),
    playerDeath: new Audio("ow.mp3"),
};

let music = {
    bgm: new Audio("bgm.mp3"),
    boss: new Audio("boss.mp3")
};

function load(src) { let i = new Image(); i.src = src; return i; }

/* ---------------- GAME VARIABLES ------------------ */

let keys = {};
let player = {
    x: 200, y: 200, w: 48, h: 48, vx: 0, vy: 0,
    hp: 5, maxHp: 5, attacking: false, attackTimer: 0
};

let gravity = 0.4;
let level = [];
let spikes = [];
let enemies = [];
let fireballs = [];
let collectibles = [];
let boss = {
    x: 5000, y: 200, w: 128, h: 128,
    hp: 20,
    active: false,
    inFrame: false,
    dead: false
};

let bossArena = { left: 4800, right: 5500 };
let gamePaused = false;
let dead = false;
let cameraX = 0;

/* ---------------- LEVEL GENERATION ------------------ */

function makePlatform(x, y, w) {
    level.push({x, y, w, h: 40});
}

function makeSpike(x, y) {
    spikes.push({x, y, w: 40, h: 40});
}

function makeEnemy(x, y, shooter = false) {
    enemies.push({
        x, y, w: 48, h: 48,
        hp: 2,
        shooter,
        shootTimer: Math.random() * 120
    });
}

function makeCollectible(x, y, name) {
    collectibles.push({x, y, w: 32, h: 32, name, collected: false});
}

/* ---------------- HUGE LEVEL ------------------ */

function buildLevel() {
    level = [];
    spikes = [];
    enemies = [];
    collectibles = [];

    // long flat level
    for (let i = 0; i < 300; i++) {
        makePlatform(i * 200, 600, 200);
    }

    makeSpike(800, 560);
    makeSpike(1200, 560);

    // enemies (no floating)
    for (let i = 0; i < 15; i++) {
        let shooter = (i % 2 === 0);
        makeEnemy(800 + i * 350, 520, shooter);
    }

    // collectibles
    makeCollectible(2000, 480, "ultimate gas");
    makeCollectible(2600, 480, "chirkbob");
    makeCollectible(3300, 480, "cheese stuck novel");
    makeCollectible(3900, 480, "prism break");
}

/* ---------------- INPUT ------------------ */

document.addEventListener("keydown", (e)=>{ 
    keys[e.key] = true; 
    if(e.key==="Escape") pauseGame(); 
});
document.addEventListener("keyup", (e)=> keys[e.key] = false);

/* ---------------- PHYSICS ------------------ */

function collides(a,b) {
    return a.x < b.x+b.w && a.x+a.w > b.x &&
           a.y < b.y+b.h && a.y+a.h > b.y;
}

/* ---------------- FIREBALLS ------------------ */

function spawnFireball(e) {
    fireballs.push({
        x: e.x, y: e.y + 20,
        vx: (player.x > e.x ? 5 : -5),
        w: 24, h: 24
    });
}

/* ---------------- BOSS ACTIVATION ------------------ */

function checkBossActivation() {
    if (boss.dead) return;

    let onScreen = boss.x - cameraX < canvas.width && boss.x - cameraX > -200;

    if (onScreen && !boss.active) {
        boss.active = true;
        music.bgm.pause();
        music.boss.loop = true;
        music.boss.play();

        // despawn all enemies when boss starts
        enemies = [];
    }

    if (boss.active) {
        // lock movement inside arena
        player.x = Math.max(player.x, bossArena.left);
        player.x = Math.min(player.x, bossArena.right - player.w);
    }
}

/* ---------------- UPDATE ------------------ */

function update() {
    if (gamePaused || dead) return;

    /* -------- Player movement ---------- */
    if (keys["ArrowLeft"]) { player.vx = -4; }
    else if (keys["ArrowRight"]) { player.vx = 4; }
    else player.vx = 0;

    if (keys["ArrowUp"]) {
        player.vy = -10;
        sfx.step.play();
    }

    player.vy += gravity;
    player.x += player.vx;
    player.y += player.vy;

    /* -------- Camera ---------- */
    cameraX = player.x - canvas.width/2;

    /* -------- Collisions ---------- */
    for (let p of level) {
        if (collides(player, p)) {
            player.y = p.y - player.h;
            player.vy = 0;
        }
    }

    for (let s of spikes) {
        if (collides(player,s)) damagePlayer();
    }

    /* -------- Enemy update ---------- */
    for (let e of enemies) {
        if (e.shooter) {
            e.shootTimer--;
            if (e.shootTimer <= 0) {
                spawnFireball(e);
                e.shootTimer = 120;
            }
        }

        if (collides(player,e)) damagePlayer();
    }

    /* -------- Fireballs ---------- */
    for (let f of fireballs) {
        f.x += f.vx;
        if (collides(player, f)) damagePlayer();
    }

    /* -------- Boss ---------- */
    if (!boss.dead) {
        checkBossActivation();

        if (boss.active) {
            if (player.x < boss.x) boss.x -= 2;
            else boss.x += 2;

            if (collides(player, boss)) damagePlayer();
        }
    }

    /* -------- Attacking ---------- */
    if (keys["z"] && !player.attacking) {
        player.attacking = true;
        player.attackTimer = 12;
    }

    if (player.attacking) {
        player.attackTimer--;
        if (player.attackTimer <= 0) player.attacking = false;

        let hitbox = {x: player.x + (player.vx>=0?40:-40), y: player.y, w:40, h:40};

        for (let e of enemies) {
            if (collides(hitbox,e)) {
                e.hp--;
                if (e.hp <= 0) {
                    sfx.enemyDeath.play();
                    enemies.splice(enemies.indexOf(e),1);
                }
            }
        }

        // boss damage
        if (collides(hitbox, boss) && boss.active && !boss.dead) {
            boss.hp--;
            if (boss.hp <= 0) {
                boss.dead = true;
                music.boss.pause();
                music.bgm.play();
                buildLevel(); // respawn enemies
            }
        }
    }

    /* -------- Death ---------- */
    if (player.hp <= 0) {
        sfx.playerDeath.play();
        dead = true;
        document.getElementById("deathMenu").style.display = "flex";
    }
}

/* ---------------- DAMAGE ------------------ */

function damagePlayer() {
    if (!dead) {
        player.hp--;
        if (player.hp <= 0) {
            dead = true;
            document.getElementById("deathMenu").style.display = "flex";
        }
    }
}

/* ---------------- DRAW ------------------ */

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(assets.bg, -cameraX*0.3, 0, canvas.width*2, canvas.height);

    for (let p of level) ctx.drawImage(assets.ground, p.x - cameraX, p.y, p.w, p.h);
    for (let s of spikes) ctx.drawImage(assets.spike, s.x - cameraX, s.y);
    for (let c of collectibles) if (!c.collected) ctx.drawImage(assets.attack, c.x - cameraX, c.y, 32, 32);
    for (let e of enemies) ctx.drawImage(assets.enemy, e.x - cameraX, e.y, e.w, e.h);

    ctx.drawImage(assets.player, player.x - cameraX, player.y, player.w, player.h);

    if (player.attacking)
        ctx.drawImage(assets.attack, player.x - cameraX + (player.vx>=0?40:-40), player.y);

    if (!boss.dead)
        ctx.drawImage(assets.boss, boss.x - cameraX, boss.y, boss.w, boss.h);

    for (let f of fireballs)
        ctx.drawImage(assets.fireball, f.x - cameraX, f.y, 24, 24);
}

/* ---------------- GAME LOOP ------------------ */

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

/* ---------------- MENU FUNCTIONS ------------------ */

function pauseGame() {
    if (dead) return;
    gamePaused = true;
    document.getElementById("pauseMenu").style.display = "flex";
}

function resumeGame() {
    gamePaused = false;
    document.getElementById("pauseMenu").style.display = "none";
}

function restartGame() {
    dead = false;
    document.getElementById("deathMenu").style.display = "none";
    player.hp = player.maxHp;
    player.x = 200;
    player.y = 200;
    buildLevel();
}

function returnToMenu() {
    location.reload();
}

/* ---------------- START ------------------ */

buildLevel();
music.bgm.loop = true;
music.bgm.play();
loop();

</script>

</body>
</html>



